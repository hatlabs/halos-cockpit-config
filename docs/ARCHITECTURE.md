# HaLOS Cockpit Config - System Architecture

**Last Modified**: 2025-12-29

## System Components

### Package Structure

The halos-cockpit-config package consists of:

1. **Branding Assets** - Static files (CSS, images) that define the visual appearance
2. **Homarr Integration** - Registry entry for dashboard integration
3. **mDNS Service** - Systemd service for subdomain advertisement
4. **Debian Package Metadata** - Control files, scripts, and build configuration
5. **Build System** - Docker container and scripts for reproducible builds
6. **Maintainer Scripts** - Pre/post install scripts for safe file management

### Component Relationships

```
┌─────────────────────────────────────────────────────────────────┐
│                      HaLOS System                                │
│                                                                  │
│  ┌──────────────────┐    ┌──────────────────┐                   │
│  │   Cockpit        │    │    Traefik       │                   │
│  │   (port 9090)    │◄───│  (generates      │                   │
│  │                  │    │   routing)       │                   │
│  └────────┬─────────┘    └──────────────────┘                   │
│           │                                                      │
│           │ branding files                                       │
│           ▼                                                      │
│  ┌──────────────────┐    ┌──────────────────┐                   │
│  │ halos-cockpit-   │    │  homarr-         │                   │
│  │ config           │───►│  container-      │                   │
│  │  - branding      │    │  adapter         │                   │
│  │  - cockpit.toml  │    │  (reads toml)    │                   │
│  │  - mDNS service  │    └──────────────────┘                   │
│  └────────┬─────────┘                                            │
│           │                                                      │
│           │ avahi-publish                                        │
│           ▼                                                      │
│  ┌──────────────────┐                                           │
│  │   Avahi Daemon   │ → cockpit.{hostname}.local                │
│  └──────────────────┘                                           │
└─────────────────────────────────────────────────────────────────┘
```

## Data Models

### Package Metadata

Defined in `debian/control`:
- Package name: halos-cockpit-config
- Dependencies: cockpit, avahi-utils
- Provides: halos-cockpit-branding, cockpit-branding-halos
- Architecture: all
- Priority: optional
- Section: admin

### File Mappings

Defined in `debian/install`:
```
Source (in package)                    → Target (on system)
etc/cockpit/branding/*                 → /usr/share/cockpit/branding/debian/
etc/halos/webapps.d/*                  → /etc/halos/webapps.d/
lib/systemd/system/*.service           → /lib/systemd/system/
usr/share/applications/cockpit.desktop → /usr/share/applications/
usr/share/pixmaps/cockpit.svg          → /usr/share/pixmaps/
```

### Diverted Files

Managed by preinst/postrm scripts:
- branding.css → branding.css.original
- logo.svg → logo.svg.original
- logo.png → logo.png.original
- apple-touch-icon.png → apple-touch-icon.png.original
- favicon.ico → favicon.ico.original

## Technology Stack

### Build Environment

- **Base Image**: Debian Trixie (stable)
- **Build Tools**: debhelper, build-essential, fakeroot, devscripts, lintian
- **Container**: Docker with docker-compose
- **Build Script**: Bash script (./run) for convenience commands

### Package Format

- **Format**: Debian Binary Package (.deb)
- **Source Format**: 3.0 (native) - defined in debian/source/format
- **Build System**: debhelper (compat level 13)

### Runtime Dependencies

- **cockpit**: The web interface being branded
- **avahi-utils**: For mDNS advertisement (avahi-publish-address)

## Integration Points

### Cockpit Web Interface

Cockpit loads branding from `/usr/share/cockpit/branding/debian/` on Debian-based systems. The package installs files to this location to override default branding.

### Homarr Dashboard

The `cockpit.toml` registry file is read by `homarr-container-adapter` to:
- Display Cockpit on the Homarr dashboard
- Provide the correct subdomain URL
- Configure card layout and category

### mDNS/Avahi

The `halos-cockpit-mdns.service` runs `avahi-publish-address` to advertise:
- `cockpit.{hostname}.local` → host IP address

### Traefik Reverse Proxy

Traefik routing for Cockpit is generated by the `traefik-container` prestart script:
- Routes `cockpit.{hostname}.local` → `host.docker.internal:9090`
- Handles HTTP→HTTPS redirect
- No auth middleware (Cockpit uses PAM)

### File System Integration

Uses dpkg-divert mechanism to handle file ownership conflicts:

1. **Pre-Installation**: preinst script diverts original files from cockpit-ws
2. **Installation**: New branding files installed to same location
3. **Post-Removal**: postrm script removes diversions, restoring originals

### APT Repository Integration

Package designed for publication to apt.hatlabs.fi repository:
- Can be installed via `apt install halos-cockpit-config`
- Updates delivered through APT infrastructure
- Included in `halos` metapackage dependencies

## Deployment Architecture

### Build Process

```
Developer → ./run build-deb → Docker Container → .deb Package
```

1. Developer runs build command
2. Docker container started with Debian Trixie environment
3. dpkg-buildpackage creates .deb from source files
4. Package artifacts returned to host system

### Installation Flow

```
.deb Package → dpkg → preinst → install files → postinst → systemd enable
```

1. Package downloaded or copied to target system
2. dpkg processes installation
3. preinst script runs: diverts cockpit-ws files
4. Package files extracted to file system
5. postinst script runs: (debhelper enables systemd services)

### Removal Flow

```
dpkg remove → prerm → remove files → postrm
```

1. User requests package removal
2. prerm script runs: (debhelper stops systemd services)
3. Package files removed from file system
4. postrm script runs: removes diversions, restores originals

## Security Considerations

### File Permissions

All branding files installed with standard permissions:
- CSS and images: 0644 (readable by all, writable by root)
- Systemd service: 0644
- No executable files in branding assets
- Maintainer scripts: 0755 (executable)

### Package Integrity

- Package signed when published to APT repository
- dpkg verifies package integrity during installation
- No network access required during installation

### Privilege Requirements

- Installation requires root privileges (standard for system packages)
- No setuid/setgid binaries
- No capability escalation
- mDNS service runs as root (required for avahi-publish)

### Supply Chain

- Source files maintained in version control (git)
- Build process reproducible via Docker
- Package build logs available for audit

## File Tree Structure

```
halos-cockpit-config/
├── .git/                       # Git repository
├── .gitignore                  # Build artifacts exclusion
├── AGENTS.md                   # AI assistant guide
├── README.md                   # User documentation
├── VERSION                     # Package version
├── run                         # Build convenience script
├── docs/
│   ├── SPEC.md                # Technical specification
│   └── ARCHITECTURE.md        # This document
├── debian/                    # Debian package files
│   ├── changelog              # Package version history
│   ├── control                # Package metadata
│   ├── copyright              # License and copyright
│   ├── install                # File installation rules
│   ├── preinst                # Pre-install script (divert files)
│   ├── postrm                 # Post-removal script (restore files)
│   ├── rules                  # Build rules (uses dh)
│   └── source/
│       └── format             # Source package format
├── docker/                    # Build environment
│   ├── Dockerfile.debtools
│   └── docker-compose.debtools.yml
├── etc/
│   ├── cockpit/branding/      # Branding assets
│   │   ├── branding.css
│   │   ├── logo.svg
│   │   ├── logo.png
│   │   ├── apple-touch-icon.png
│   │   └── favicon.ico
│   └── halos/webapps.d/       # Homarr registry
│       └── cockpit.toml
├── lib/systemd/system/        # Systemd services
│   └── halos-cockpit-mdns.service
└── usr/
    ├── share/applications/
    │   └── cockpit.desktop
    └── share/pixmaps/
        └── cockpit.svg
```

## Design Decisions

### Why dpkg-divert?

Alternative approaches considered:
1. **Install to /etc/cockpit/branding/** - Cockpit's override mechanism didn't work reliably in testing
2. **Conflicts: cockpit-ws** - Would prevent installation alongside cockpit-ws, breaking the system
3. **dpkg-divert (chosen)** - Safely replaces files while maintaining package ownership

Rationale: dpkg-divert is the standard Debian mechanism for packages that need to replace files from other packages. It's well-understood, reliable, and reversible.

### Why Docker-based builds?

Alternative approaches:
1. **Build on host** - Requires installing Debian packaging tools on macOS/other platforms
2. **CI-only builds** - Slower developer feedback, no local testing
3. **Docker (chosen)** - Consistent environment, works on all platforms, fast local builds

Rationale: Docker provides a consistent Debian Trixie environment for builds regardless of host platform, enabling developers to build and test locally before pushing.

### Why separate mDNS service?

Alternative approaches:
1. **Extend halos-mdns-publisher** - Add static subdomain config support
2. **Generate in Traefik prestart** - But mDNS is separate from routing
3. **Dedicated systemd service (chosen)** - Simple, focused, tied to Cockpit lifecycle

Rationale: Cockpit is the only native (non-container) web service in HaLOS. A dedicated service is simpler than modifying halos-mdns-publisher for this single case. If more native services are added in the future, we can revisit.

### Why Traefik routing in traefik-container?

Alternative approaches:
1. **Static config in this package** - But needs hostname templating
2. **Generate at package install** - Doesn't handle hostname changes
3. **Generate in Traefik prestart (chosen)** - Handles hostname changes, consistent with other routing

Rationale: The Traefik prestart script already handles hostname-dependent configuration. Adding Cockpit routing there keeps all Traefik configuration in one place and ensures it's regenerated when the hostname changes.
